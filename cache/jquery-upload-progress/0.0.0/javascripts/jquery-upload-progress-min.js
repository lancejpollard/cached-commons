(function(a){a.fn.uploadProgress=function(b){b=a.extend({dataType:"json",interval:2000,progressBar:"#progressbar",progressUrl:"/progress",start:function(){},uploading:function(){},complete:function(){},success:function(){},error:function(){},preloadImages:[],uploadProgressPath:"/javascripts/jquery.uploadProgress.js",jqueryPath:"/javascripts/jquery.js",timer:""},b);a(function(){for(var e=0;e<b.preloadImages.length;e++){b.preloadImages[e]=a("<img>").attr("src",b.preloadImages[e])}if(a.browser.safari&&top.document==document){iframe=document.createElement("iframe");iframe.name="progressFrame";a(iframe).css({width:"0",height:"0",position:"absolute",top:"-3000px"});document.body.appendChild(iframe);var g=iframe.contentWindow.document;g.open();g.write("<html><head></head><body></body></html>");g.close();var c=g.body;var f=g.createElement("script");f.src=b.jqueryPath;f.onload=function(){var d=g.createElement("script");d.src=b.uploadProgressPath;c.appendChild(d)};c.appendChild(f)}});return this.each(function(){a(this).bind("submit",function(){var c="";for(i=0;i<32;i++){c+=Math.floor(Math.random()*16).toString(16)}b.uuid=c;b.start();if(old_id=/X-Progress-ID=([^&]+)/.exec(a(this).attr("action"))){var d=a(this).attr("action").replace(old_id[1],c);a(this).attr("action",d)}else{a(this).attr("action",jQuery(this).attr("action")+"?X-Progress-ID="+c)}var e=a.browser.safari?progressFrame.jQuery.uploadProgress:jQuery.uploadProgress;b.timer=window.setInterval(function(){e(this,b)},b.interval)})})};jQuery.uploadProgress=function(c,b){jQuery.ajax({type:"GET",url:b.progressUrl+"?X-Progress-ID="+b.uuid,dataType:b.dataType,success:function(d){if(d.state=="uploading"){d.percents=Math.floor((d.received/d.size)*1000)/10;var e=a.browser.safari?a(b.progressBar,parent.document):a(b.progressBar);e.css({width:d.percents+"%"});b.uploading(d)}if(d.state=="done"||d.state=="error"){window.clearTimeout(b.timer);b.complete(d)}if(d.state=="done"){b.success(d)}if(d.state=="error"){b.error(d)}}})}})(jQuery);
